## 第六章 物理内存管理

### 6.1 内存管理策略

- 虚拟内存系统将程序中使用的内存地址和实际的物理地址进行了隔离（通过分页机制和页面交换机制）
- 设计过程中需要考虑内部碎片与外部碎片
- Lcore的内存管理系统主要由三部分组成：内核启动初始化阶段使用的早期内存管理器Bootmem，以及在性能、碎片方面有诸多优点的Buddy系统和Slab系统

### 6.2 Bootmem管理实现

#### 6.2.1 Bootmem数据结构

- bootmm数据结构是其核心，用来管理整个物理内存
  - phymm表示机器总共的物理内存大小，以字节为单位
  - max_pfn表示系统中最大的物理页框号
  - 会有一张位图，每一项对于一个物理页面，反应是否被占用。s_map表示起始地址，e_map表示位图的末尾
  - last_alloc表示最近一次分配的位置
  - Info数组用来记录当前内存中按照内存区域类型划分的使用情况
  - cnt_infos表示其中有效项的项数，其值必须小于MAX_INFO

### 6.3 Buddy系统实现

#### 6.3.1 Buddy系统数据结构

- buddy_sys是其核心，维护了整个伙伴系统的信息
  - buddy_start_pfn和buddy_end_pfn分别表示伙伴系统的起始和结束物理页框号
  - start_page表示伙伴系统管理的页面中第一个物理页框所对应的page对象的地址
  - freelist数组是所有支持的order对应的freelist链表

### 6.4 Slub系统实现

#### 6.3.1 Slub系统数据结构

- kmem_cache结构体是Slub内存管理系统的核心，维护了每个Slub缓存的基本信息
  - size表示Slub缓存中每个对象实际要占多大的内存空间
  - objsize表示对象本身需要多少内存空间（需要对齐）
  - offset表示Slub内存页面中用于存放队形的内存地址相对于此页面的偏移
  - node是对应的kmem_cache_node对象
  - cpu是对应的kmem_cache_cpu对象
  - name是整个Slub缓存的名字