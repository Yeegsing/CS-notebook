## 第八章 实现文件系统

### 8.1 SD卡驱动程序实现

### 8.2 文件系统实现

#### 8.2.1 文件控制块的实现

何谓文件控制块？常用的文件操作函数如fopen、fclose、fscanf等，它们的共同特点就是有一个参数是FILE *型的指针，这个FILE数据结构就是所谓的**文件控制块**。

#### 8.2.2 缓存机制的实现

- 缓存替换算法用于当缓冲区满时选取一个缓存块作为victim，将其内容同步到磁盘上，之后从磁盘上读取到的数据就将占用这个缓存块所在的位置。
- 此时考虑到片上系统的SD卡写入操作比读取慢很多，算法就应该优先选择不脏（没有被更改过的）缓存块进行替换，于是选择CLOCK算法。
- CLOCK算法又名second chance算法，其特点在于维护一个reference bit，用于记录这个缓存块最近是否被访问过。
- 算法将缓冲区看作一个循环队列，依次对reference bit进行判断，如果是0，就直接选用这个块作为victim，否则就将它的reference bit置为0（可见两轮之内肯定能找到victim）
- 此处对这个算法的改进：同时维护一个dirty bit，用于记录这个块是否被修改过。这样可以优先选择dirty bit为0的块，以减少一次SD卡的写入操作（会给修改过的块第二次机会，下一次再选择它为victim）

#### 8.2.3 FAT表

- FAT32文件系统的核心--FAT表（File Allocation Table）
- FAT表项与簇Cluster的映射、簇Cluster与扇区Sector之间的映射、扇区Sector与目录项之间的映射

#### 8.2.4 文件系统初始化

- Lcore中实现的是Sector大小为512B、Cluster大小为4096B

#### 8.2.5 打开文件

#### 8.2.6 关闭文件

- 主要有两项操作：一是将各种缓存同步到磁盘上，二是对磁盘上文件的目录项进行更新

#### 8.2.7 文件读取

- 首先根据文件控制块中存储的目录项内容、当前的文件位置指针以及传入的要读取的字节数，计算出要读取的内容的起始和结束地址（第几个Cluster的第几个字节）
- 然后程序将Cluster读进文件控制块的内部缓存中，之后顺序地一个个读取（砧板切肉既视感）

#### 8.2.8 文件写入

- 与读取操作类似，只不过需要注意如果发现已经写完该文件的最后一个Cluster，仍有数据要读入，此时就需要为这个文件重新分配Cluster。
- 在重新分配后，直接在文件的局部缓存中选取一个缓存块替换并清空，这样可以避免SD卡的读取操作。

#### 8.2.9 创建文件

- 首先需要判断要创建的文件是否存在，如果存在则直接出错退出。
- 然后程序根据传入的路径顺序打开要创建的文件所在的文件夹，并查找一个空目录的位置（本身为空或带有删除标记）
- 之后，程序在这个位置将文件名，文件属性等信息写入。
- 最后，由于文件夹内的目录项是在全局缓存内存储的，程序要将所有的全局缓存内容写到磁盘上。



