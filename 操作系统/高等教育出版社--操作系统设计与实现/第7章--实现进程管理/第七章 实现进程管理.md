## 第七章 实现进程管理

### 7.1 进程管理初始化

#### 7.1.1 进程数据结构

- Lcore与进程相关的结构体主要有三个：regs_context、task_struct和task_union。
- 其中，regs_context用来存储进程的上下文信息，当进程被换出时会将相关内容存储在这个结构中，当进程被调入时则从这个结构体中载入相应的数据。
- task_struct结构体，是进程管理的核心数据结构，用来描述进程相关的一切信息，内核在内存中会为每一个进程维护一个此数据结构对象，并在进程退出时将它释放。
  - 其中，user_stack表示进程用户态堆栈的栈顶指针
  - user_code表示用户态代码的起始线性地址
  - pid表示该进程的进程id号
  - state表示该进程的当前状态，可能取值为
    - _TASK_UNINIT
    - _TASK_READY
    - _TASK_RUNNING
    - _TASK_BLOCKED
  - counter表示进程可以使用的CPU时间片数目，每次时钟中断时会将当前正在运行的进程的counter值减1，当其值变为0时需要通过调度器来决定让哪个进程来执行。
  - pgd指向进程页表的页目录（第一级），每个进程拥有独立的线性地址空间，在进程切换时会将新进程的pgd载入cp0寄存组的页目录基址寄存器中。
  - sched用于将此进程对象链接到相应的调度链表中
  - node用于将此进程对象链接到相应的调度链表中
  - 内核中定义了一个vma结构体，用来描述进程地址空间中的每一个线性地址区间
    - stack_vma_head是进程用户态栈所使用的vma对象所组成的链表首部
    - user_vma_head是进程用户代码区域所使用的vma对象所组成的链表首部
    - heap_vma_head是进程用户态堆所使用的vma对象所组成的链表首部
- 最后是task_union联合体。**TIP**：栈的拓展是从高地址到低地址的，多数情况下内核栈的底部较大一片区域是空闲的，因此将每个进程的task_struct对象保存在进程内核栈的底部（需保证不过度使用栈）。
- 此外还有一个前面章节提到过的vma结构体，该结构用来描述进程线性地址空间中的一块**线性区间**，进程同一类的vma对象会链接到一个链表中
  - node是vma对象的链接件
  - start表示该线性区域的起始地址
  - cnt表示这个线性区域的大小，以页大小为单位
  - vend记录了此线性区域的结束线性地址

#### 7.1.2 进程初始化

### 7.2 进程创建

### 7.3 页异常处理

#### 7.3.1 缺页异常处理

- 缺页异常在被访问的页面不在物理内存中时发送。
- 由于Lcore没有添加页面换进换出的功能，因此使用缺页异常处理可以用来引入按需加载的特性

#### 7.3.2 写保护异常

- 常用在进程之间共享页面的场景下，如果都是读取操作不会带来异常，对于写操作则需要复制一个副本，在副本上进行相关修改

### 7.4 进程调度

#### 7.4.1 调度初始化

